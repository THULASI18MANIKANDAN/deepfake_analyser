<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Deepfake Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    {% extends "base.html" %}
    
    {% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-file-pdf me-2"></i>Reports</h1>
                    <div>
                        <button class="btn btn-success me-2" onclick="generateWeeklyReport()">
                            <i class="fas fa-calendar-week me-2"></i>Generate Weekly Report
                        </button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#emailSettingsModal">
                            <i class="fas fa-cog me-2"></i>Email Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Generation Cards -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-file-alt fa-3x text-primary mb-3"></i>
                        <h5>Analysis Reports</h5>
                        <p class="text-muted">Generate detailed PDF reports for individual analyses with technical insights and visualizations.</p>
                        <button class="btn btn-primary" onclick="showAnalysisSelector()">
                            <i class="fas fa-plus me-2"></i>Generate Report
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
                        <h5>Weekly Summary</h5>
                        <p class="text-muted">Comprehensive weekly reports with trends, statistics, and recommendations for your analysis activity.</p>
                        <button class="btn btn-success" onclick="generateWeeklyReport()">
                            <i class="fas fa-calendar-week me-2"></i>Generate Weekly
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body text-center">
                        <i class="fas fa-envelope fa-3x text-info mb-3"></i>
                        <h5>Email Reports</h5>
                        <p class="text-muted">Automatically receive reports via email and set up notifications for analysis completion.</p>
                        <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#emailSettingsModal">
                            <i class="fas fa-cog me-2"></i>Configure Email
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Reports -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i>Recent Reports</h5>
                    </div>
                    <div class="card-body">
                        {% if reports %}
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Type</th>
                                            <th>Generated</th>
                                            <th>Analysis</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for report in reports %}
                                        <tr>
                                            <td>
                                                <span class="badge bg-{{ 'primary' if report.report_type == 'analysis' else 'success' }}">
                                                    {{ report.report_type.title() }}
                                                </span>
                                            </td>
                                            <td>{{ report.created_at }}</td>
                                            <td>
                                                {% if report.analysis_id %}
                                                    <a href="{{ url_for('view_analysis', analysis_id=report.analysis_id) }}" class="text-decoration-none">
                                                        Analysis #{{ report.analysis_id }}
                                                    </a>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary me-2" onclick="downloadReport('{{ report.file_path.split('/')[-1] }}')">
                                                    <i class="fas fa-download me-1"></i>Download
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" onclick="emailReport('{{ report.file_path.split('/')[-1] }}')">
                                                    <i class="fas fa-envelope me-1"></i>Email
                                                </button>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-file-pdf fa-3x text-muted mb-3"></i>
                                <h5>No Reports Generated</h5>
                                <p class="text-muted">Generate your first report to see it here</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Selector Modal -->
    <div class="modal fade" id="analysisSelectorModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Analysis for Report</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="analysisSelector">
                        <p>Loading analyses...</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="generateAnalysisReport" disabled>
                        Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Settings Modal -->
    <div class="modal fade" id="emailSettingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Email Notification Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="emailSettingsForm">
                        <div class="mb-3">
                            <label for="emailAddress" class="form-label">Email Address</label>
                            <input type="email" class="form-control" id="emailAddress" value="{{ session.user_email }}">
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="notifyAnalysisComplete">
                                <label class="form-check-label" for="notifyAnalysisComplete">
                                    Notify when analysis is complete
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="weeklyReports">
                                <label class="form-check-label" for="weeklyReports">
                                    Send weekly summary reports
                                </label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="securityAlerts">
                                <label class="form-check-label" for="securityAlerts">
                                    Security and system alerts
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEmailSettings()">
                        Save Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let selectedAnalysisId = null;

        function showAnalysisSelector() {
            // Load recent analyses
            fetch('/api/v1/analyses?per_page=20')
                .then(response => response.json())
                .then(data => {
                    const selector = document.getElementById('analysisSelector');
                    
                    if (data.analyses && data.analyses.length > 0) {
                        let html = '<div class="list-group">';
                        data.analyses.forEach(analysis => {
                            html += `
                                <div class="list-group-item list-group-item-action analysis-item" data-id="${analysis.id}">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">${analysis.filename}</h6>
                                        <small>${analysis.created_at}</small>
                                    </div>
                                    <p class="mb-1">Result: <span class="badge bg-${analysis.result === 'Fake' ? 'danger' : 'success'}">${analysis.result}</span></p>
                                    <small>Confidence: ${(analysis.confidence * 100).toFixed(1)}%</small>
                                </div>
                            `;
                        });
                        html += '</div>';
                        selector.innerHTML = html;
                        
                        // Add click handlers
                        document.querySelectorAll('.analysis-item').forEach(item => {
                            item.addEventListener('click', function() {
                                document.querySelectorAll('.analysis-item').forEach(i => i.classList.remove('active'));
                                this.classList.add('active');
                                selectedAnalysisId = this.dataset.id;
                                document.getElementById('generateAnalysisReport').disabled = false;
                            });
                        });
                    } else {
                        selector.innerHTML = '<p class="text-muted">No analyses found. Upload and analyze some files first.</p>';
                    }
                })
                .catch(error => {
                    document.getElementById('analysisSelector').innerHTML = '<p class="text-danger">Error loading analyses.</p>';
                });
            
            new bootstrap.Modal(document.getElementById('analysisSelectorModal')).show();
        }

        function generateWeeklyReport() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            btn.disabled = true;

            fetch('/generate_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ type: 'weekly' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Weekly report generated successfully!');
                    location.reload();
                } else {
                    alert('Error generating report: ' + data.message);
                }
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        }

        document.getElementById('generateAnalysisReport').addEventListener('click', function() {
            if (!selectedAnalysisId) return;

            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
            btn.disabled = true;

            fetch('/generate_report', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    type: 'analysis',
                    analysis_id: selectedAnalysisId 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Analysis report generated successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('analysisSelectorModal')).hide();
                    location.reload();
                } else {
                    alert('Error generating report: ' + data.message);
                }
            })
            .finally(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            });
        });

        function downloadReport(filename) {
            window.location.href = `/download_report/${filename}`;
        }

        function emailReport(filename) {
            const email = prompt('Enter email address:', '{{ session.user_email }}');
            if (email) {
                fetch('/email_report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        filename: filename,
                        email: email 
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Report emailed successfully!');
                    } else {
                        alert('Error sending email: ' + data.message);
                    }
                });
            }
        }

        function saveEmailSettings() {
            alert('Email settings saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('emailSettingsModal')).hide();
        }
    </script>
    {% endblock %}
</body>
</html>
